"use client";
import React, { FC, useEffect, useState } from "react";
import Title from "../../components/Title";
import {
	Bar,
	BarChart,
	CartesianGrid,
	LabelList,
	Legend,
	Line,
	LineChart,
	ResponsiveContainer,
	Tooltip,
	TooltipProps,
	XAxis,
	YAxis
} from "recharts";
import BlockBackground from "@/app/components/BlockBackground";
import Spinner from "@/app/components/Spinner";
import Link from "next/link";
interface Data {
	date: string,
	Views: number,
	Users: number,
};

interface PageData {
	Title: string,
	Views: number,
};

interface IBarChartLabel {
	x: number;
	y: number;
	value: string;
}

const Page = () => {
	const [username, setUsername] = useState("");
	const [data, setData] = useState<Data[]>([]);
	const [pageData, setPageData] = useState<PageData[]>([]);

	const getUsername = async () => {
		const response = await fetch('/api/me', { cache: 'no-cache' });
		const res_json = await response.json();
		setUsername(res_json.username ? `Halo, ${res_json.username}` : "Halo, Admin");
	};

	async function runViewUserReport() {
		const res = await fetch('/api/ga/view_and_user', {
			cache: 'no-store'
		});
		const resJson = await res.json();
		setData(resJson.data);
	}

	async function runPageViewReport() {
		const res = await fetch('/api/ga/page_view', {
			cache: 'no-store'
		});
		const resJson = await res.json();
		setPageData(resJson.data);
	}

	useEffect(() => {
		getUsername();
		runViewUserReport();
		runPageViewReport();
	}, []);

	const BarChartLabel: FC<IBarChartLabel> = ({
		x,
		y,
		value,
	}: {
		x: number;
		y: number;
		value: string;
	}) => {
		const newX = x + 5;
		const newY = y - 5;
		return (
			<text
				x={newX}
				y={newY}
				fill="#000000"
				textAnchor="start"
				fontFamily="Poppins"
				fontSize="12"
			>
				{value.length >= 18 ? value?.slice(0, 18) + "..." : value}
			</text>
		);
	};

	const CustomTooltip: FC<TooltipProps<number, string>> = ({ active, payload, label }) => {
		if (active && payload && payload.length) {
			return (
				<div
					style={{
						maxWidth: "30vw",
						backgroundColor: "white",
						border: "1px solid black",
						padding: "8px"
					}}
				>
					<p style={{ margin: 0, fontWeight: "bold" }}>{label}</p>
					{payload.map((item, index) => (
						<p key={index} style={{ margin: 0 }}>
							{item.name}: {item.value}
						</p>
					))}
				</div>
			);
		}

		return null;
	};

	if (!username) {
		return (
			<BlockBackground bgColor="bg-white">
				<Spinner />
			</BlockBackground>
		);
	}

	return (
		<>
			{username && (
				<div className="w-full flex flex-col justify-center items-center">
					<h3 className="text-3xl self-start">{username}</h3><br />
					<Title title="Weekly Performance" />
					<br />

					<h3 className="text-3xl font-bold">Number of Views and Active Users</h3>
					<div className="w-[90%] h-[300px] flex justify-center items-center">
						<ResponsiveContainer width="100%" height="100%">
							<LineChart data={data}>
								<CartesianGrid strokeDasharray="3 3" />
								<XAxis dataKey="date" />
								<YAxis />
								<Tooltip content={<CustomTooltip />} />
								<Legend />
								<Line dataKey="Views" type="natural" stroke="#000000" />
								<Line dataKey="Users" type="natural" stroke="#00FF00" />
							</LineChart>
						</ResponsiveContainer>
					</div >
					<br />
					<h3 className="text-3xl font-bold">Top 5 Pages Based on Views</h3>
					<div className="w-[90%] h-[300px] flex justify-center items-center">
						<ResponsiveContainer width="100%" height="100%">
							<BarChart data={pageData} layout="vertical" barCategoryGap={18}>
								<CartesianGrid strokeDasharray="3 3" />
								<YAxis dataKey="Title" type="category" axisLine={false} display="none" />
								<XAxis type="number" />
								<Tooltip content={<CustomTooltip />} />
								<Bar dataKey="Views" fill="#000000">
									<LabelList
										dataKey="Title"
										position="top"
										fill="#000000"
										content={<BarChartLabel x={-1} y={-1} value="Title" />}
									/>
								</Bar>
							</BarChart>
						</ResponsiveContainer>
					</div>

					<div className="w-full flex justify-center items-center gap-5">
						<Link
							href="https://analytics.google.com/analytics/web/"
							className="flex justify-start items-center gap-2 p-2 rounded-md border-2 border-black bg-orange-500"
							target="_blank"
						>
							<p className="font-semibold">Go to </p>
							<div className="h-16 w-auto">
								<svg
									xmlns="http://www.w3.org/2000/svg"
									viewBox="26 -29 120 60"
									width={120}
									height={60}
								>
									<linearGradient
										gradientUnits="userSpaceOnUse"
										x1={173.867}
										y1={-72.65}
										x2={216.749}
										y2={-72.65}
									>
										<stop offset={0} stopColor="#e96f0b" />
										<stop offset={1} stopColor="#f37901" />
									</linearGradient>
									<g fill="#000000">
										<path d="M74.093 7.228l2.388 6.27h-4.627l2.24-6.27zm-.896-2.1l-5.224 13.73h1.94l1.343-3.73h5.82l1.343 3.73h1.94l-5.224-13.73h-1.94zm28.2 13.742h1.8V5.138h-1.8v13.73zm-18.35-8.07c.597-.896 1.8-1.642 2.985-1.642 2.388 0 3.582 1.642 3.582 4.03v5.82h-1.8v-5.522c0-1.94-1.045-2.687-2.388-2.687-1.493 0-2.537 1.493-2.537 2.836v5.224h-1.8V9.32h1.8l.15 1.493zm8.06 5.234c0-2.1 1.94-3.284 4.18-3.284 1.343 0 2.24.3 2.537.597v-.3c0-1.493-1.194-2.24-2.388-2.24-1.045 0-1.94.448-2.24 1.343l-1.642-.746c.3-.896 1.493-2.24 3.88-2.24 2.24 0 4.18 1.343 4.18 4.03v5.672h-1.642v-1.343h-.15c-.448.746-1.493 1.642-3.134 1.642-1.94 0-3.582-1.194-3.582-3.134m6.716-1.194s-.746-.597-2.24-.597c-1.8 0-2.537 1.045-2.537 1.8 0 1.045 1.045 1.493 1.94 1.493 1.343 0 2.836-1.194 2.836-2.687" />
										<path
											d="M105.735 23.05l2.1-4.925-3.73-8.657h1.8l2.836 6.567 2.836-6.567h1.8l-5.82 13.582h-1.8zm26.27-10.45c-.448-1.194-1.493-1.94-2.537-1.94-1.493 0-2.836 1.343-2.836 3.284s1.343 3.284 2.836 3.284c1.045 0 2.1-.746 2.537-1.8l1.493.896c-.746 1.642-2.24 2.687-4.03 2.687-2.537 0-4.627-2.24-4.627-5.075 0-2.985 2.1-5.075 4.627-5.075 1.8 0 3.284 1.045 4.03 2.687l-1.493 1.045z"
											fillRule="evenodd"
										/>
										<path d="M138.422 19.168c2.388 0 3.582-1.343 3.582-2.985 0-3.582-5.224-2.24-5.224-4.328 0-.746.597-1.194 1.642-1.194s2.1.448 2.537 1.194l1.045-1.045c-.597-.746-2.24-1.8-3.73-1.8-2.24 0-3.433 1.343-3.433 2.985 0 3.433 5.373 2.24 5.373 4.03 0 .896-.597 1.493-1.8 1.493s-1.8-.746-2.388-1.493L134.7 17.08c.896.896 2.24 2.1 3.73 2.1zm-17.015-.298h1.8V9.318h-1.8v9.552z" />
										<path
											d="M122.153 4.7c.746 0 1.194.597 1.194 1.194 0 .746-.597 1.194-1.194 1.194s-1.194-.597-1.194-1.194.597-1.194 1.194-1.194zm-2.537 12.687l.3 1.343h-1.8c-1.642 0-2.388-1.194-2.388-2.985V11.1h-1.8V9.3h1.8V6.482h1.8v2.836h2.1v1.8h-2.1v4.925c0 1.343 1.045 1.343 2.1 1.343z"
											fillRule="evenodd"
										/>
										<path d="M77.048-10.042v2.24h5.224c-.15 1.194-.597 2.1-1.194 2.687-.746.746-1.94 1.642-4.03 1.642-3.134 0-5.672-2.537-5.672-5.82 0-3.134 2.537-5.82 5.672-5.82 1.8 0 2.985.746 3.88 1.493l1.493-1.493c-1.343-1.194-2.985-2.24-5.373-2.24-4.328 0-8.06 3.582-8.06 7.9s3.73 7.9 8.06 7.9c2.388 0 4.18-.746 5.522-2.24 1.493-1.493 1.94-3.433 1.94-5.075 0-.448 0-1.045-.15-1.343h-7.313zm13.282-1.8c-2.836 0-5.075 2.1-5.075 5.075s2.24 5.075 5.075 5.075a5.03 5.03 0 0 0 5.075-5.075c0-2.985-2.24-5.075-5.075-5.075zm0 8.2c-1.493 0-2.836-1.343-2.836-3.134S88.837-9.9 90.33-9.9s2.837 1.2 2.837 3.13-1.343 3.134-2.836 3.134zm24.47-7.156c-.597-.597-1.493-1.194-2.836-1.194-2.537 0-4.776 2.24-4.776 5.075s2.24 5.075 4.776 5.075c1.194 0 2.24-.597 2.687-1.194h.15v.746c0 1.94-1.045 2.985-2.687 2.985-1.343 0-2.24-1.045-2.537-1.8l-1.94.746c.597 1.343 2.1 2.985 4.478 2.985 2.687 0 4.925-1.493 4.925-5.373V-12h-2.1v1.194zm-2.537 7.164c-1.493 0-2.687-1.343-2.687-3.134s1.194-3.134 2.687-3.134 2.687 1.343 2.687 3.134-1.194 3.134-2.687 3.134zm-10.897-8.2c-2.836 0-5.075 2.1-5.075 5.075s2.24 5.075 5.075 5.075a5.03 5.03 0 0 0 5.075-5.075c.15-2.985-2.24-5.075-5.075-5.075zm0 8.2c-1.493 0-2.836-1.343-2.836-3.134s1.343-3.134 2.836-3.134 2.836 1.194 2.836 3.134-1.343 3.134-2.836 3.134zM118.7-17.206h2.24v15.522h-2.24v-15.522zm8.358 13.582c-1.194 0-1.94-.597-2.537-1.493l6.866-2.836-.3-.597c-.448-1.194-1.8-3.284-4.328-3.284-2.687 0-4.776 2.1-4.776 5.075a5.03 5.03 0 0 0 5.075 5.075c2.388 0 3.73-1.493 4.328-2.24l-1.8-1.194c-.597.896-1.343 1.493-2.537 1.493zm-.15-6.27c.896 0 1.642.448 1.94 1.194l-4.627 1.94c0-2.24 1.493-3.134 2.687-3.134z" />
									</g>
									<g transform="matrix(.198617 0 0 .198616 29.128442 -18.08775)">
										<path
											d="M130 29v132c0 14.77 10.2 23 21 23 10 0 21-7 21-23V30c0-13.54-10-22-21-22s-21 9.33-21 21z"
											fill="#f9ab00" strokeWidth="5" stroke="black"
										/>
										<g fill="#e37400">
											<path d="M75 96v65c0 14.77 10.2 23 21 23 10 0 21-7 21-23V97c0-13.54-10-22-21-22s-21 9.33-21 21z" strokeWidth="5" stroke="black" />
											<circle r={21} cy={163} cx={41} strokeWidth="5" stroke="black" />
										</g>
									</g>
								</svg>
							</div>
						</Link>

						<Link
							href={`${process.env.STRAPI_URL}`}
							className="flex justify-start items-center gap-2 p-2 rounded-md border-2 border-black bg-white"
							target="_blank"
						>
							<p className="font-semibold">Go to </p>
							<div className="h-16 w-auto">
								<svg
									width="100%"
									height="100%"
									viewBox="0 0 488 408"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
								>
									<path
										d="M145 69.3333C145 36.6493 145 20.3073 155.154 10.1536C165.307 0 181.649 0 214.333 0H275.667C308.351 0 324.693 0 334.846 10.1536C345 20.3073 345 36.6493 345 69.3333V130.667C345 163.351 345 179.693 334.846 189.846C324.693 200 308.351 200 275.667 200H214.333C181.649 200 165.307 200 155.154 189.846C145 179.693 145 163.351 145 130.667V69.3333Z"
										fill="#4945FF"
									/>
									<path
										fillRule="evenodd"
										clipRule="evenodd"
										d="M283 60.6665H215.667V94.9998H250V129.333H284.334V61.9998C284.334 61.2635 283.737 60.6665 283 60.6665Z"
										fill="white"
									/>
									<rect x={248.666} y={95} width={1.33333} height={1.33333} fill="white" />
									<path
										d="M215.666 95H248.666C249.402 95 249.999 95.597 249.999 96.3333V129.333H216.999C216.263 129.333 215.666 128.736 215.666 128V95Z"
										fill="#9593FF"
									/>
									<path
										d="M250 129.333H284.333L251.138 162.528C250.718 162.948 250 162.651 250 162.057V129.333Z"
										fill="#9593FF"
									/>
									<path
										d="M215.666 94.9998H182.942C182.348 94.9998 182.051 94.2817 182.471 93.8618L215.666 60.6665V94.9998Z"
										fill="#9593FF"
									/>
									<path
										d="M462.783 261.36C465.698 264.292 469.141 265.758 473.112 265.758C477.206 265.758 480.711 264.292 483.626 261.36C486.542 258.428 488 254.966 488 250.973C488 246.98 486.542 243.486 483.626 240.492C480.711 237.497 477.206 236 473.112 236C469.141 236 465.698 237.497 462.783 240.492C459.867 243.486 458.409 246.98 458.409 250.973C458.409 254.966 459.867 258.428 462.783 261.36Z"
										fill="#212067"
									/>
									<path
										d="M148.819 299.643C148.819 299.95 148.572 300.198 148.266 300.198H127.789V339.128C127.789 342.372 128.596 344.743 130.209 346.24C131.822 347.737 134.179 348.579 137.281 348.767C140.119 348.938 143.579 348.926 147.663 348.732L147.768 348.727L147.957 348.718L148.237 348.703C148.553 348.687 148.819 348.94 148.819 349.258V370.074C148.819 370.357 148.607 370.595 148.327 370.625C148.191 370.64 148.053 370.656 147.952 370.667C131.91 372.386 120.567 370.795 113.925 365.892C107.163 360.901 103.782 351.98 103.782 339.128V300.198H88.1443C87.8384 300.198 87.5904 299.95 87.5904 299.643V277.546C87.5904 277.239 87.8384 276.991 88.1443 276.991H103.782V261.534C103.782 261.094 104.041 260.696 104.442 260.518L127.012 250.528C127.378 250.366 127.789 250.635 127.789 251.036V276.991H148.266C148.572 276.991 148.819 277.239 148.819 277.546V299.643Z"
										fill="#212067"
									/>
									<path
										d="M192.353 293.085C194.586 287.096 198.277 282.604 203.426 279.61C208.138 276.869 213.344 275.383 219.043 275.15C219.318 275.139 219.74 275.131 220.082 275.125C220.39 275.12 220.641 275.37 220.641 275.678V301.075C220.641 301.605 220.181 302.013 219.654 301.965C212.731 301.335 206.516 302.867 201.007 306.561C195.237 310.429 192.353 316.854 192.353 325.838V370.014C192.353 370.321 192.105 370.57 191.799 370.57H168.899C168.593 370.57 168.345 370.321 168.345 370.014V277.544C168.345 277.238 168.593 276.989 168.899 276.989H191.799C192.105 276.989 192.353 277.238 192.353 277.544V293.085Z"
										fill="#212067"
									/>
									<path
										fillRule="evenodd"
										clipRule="evenodd"
										d="M305.871 276.988C305.566 276.988 305.318 277.236 305.318 277.543V288.03C298.121 278.922 288.01 274.368 274.982 274.368C262.575 274.368 251.936 279.14 243.065 288.685C234.194 298.231 229.758 309.928 229.758 323.778C229.758 337.628 234.194 349.325 243.065 358.87C251.936 368.416 262.575 373.188 274.982 373.188C288.01 373.188 298.121 368.634 305.318 359.525V370.013C305.318 370.319 305.566 370.568 305.871 370.568H328.771C329.077 370.568 329.325 370.319 329.325 370.013V277.543C329.325 277.236 329.077 276.988 328.771 276.988H305.871ZM261.022 342.869C265.861 347.736 272.003 350.169 279.447 350.169C286.891 350.169 293.064 347.704 297.965 342.776C302.865 337.847 305.316 331.515 305.316 323.779C305.316 316.043 302.865 309.711 297.965 304.782C293.064 299.854 286.891 297.389 279.447 297.389C272.003 297.389 265.861 299.854 261.022 304.782C256.184 309.711 253.764 316.043 253.764 323.779C253.764 331.515 256.184 337.878 261.022 342.869Z"
										fill="#212067"
									/>
									<path
										fillRule="evenodd"
										clipRule="evenodd"
										d="M433.599 288.685C424.727 279.14 414.026 274.368 401.495 274.368C388.468 274.368 378.418 278.922 371.346 288.03V277.543C371.346 277.236 371.098 276.988 370.792 276.988H347.892C347.586 276.988 347.338 277.236 347.338 277.543V407.445C347.338 407.751 347.586 408 347.892 408H370.792C371.098 408 371.346 407.751 371.346 407.445V359.525C378.418 368.634 388.468 373.188 401.495 373.188C414.026 373.188 424.727 368.416 433.599 358.87C442.47 349.325 446.905 337.628 446.905 323.778C446.905 309.928 442.47 298.231 433.599 288.685ZM378.602 342.869C383.441 347.736 389.582 350.169 397.027 350.169C404.471 350.169 410.644 347.704 415.544 342.776C420.445 337.847 422.896 331.515 422.896 323.779C422.896 316.043 420.445 309.711 415.544 304.782C410.644 299.854 404.471 297.389 397.027 297.389C389.582 297.389 383.441 299.854 378.602 304.782C373.763 309.711 371.344 316.043 371.344 323.779C371.344 331.515 373.763 337.878 378.602 342.869Z"
										fill="#212067"
									/>
									<path
										d="M461.757 370.57C461.451 370.57 461.203 370.321 461.203 370.015V277.545C461.203 277.238 461.451 276.99 461.757 276.99H484.657C484.963 276.99 485.211 277.238 485.211 277.545V370.015C485.211 370.321 484.963 370.57 484.657 370.57H461.757Z"
										fill="#212067"
									/>
									<path
										d="M33.2152 309.647C29.9273 308.087 28.2833 306.06 28.2833 303.564C28.2833 301.194 29.3069 299.322 31.3541 297.95C33.4013 296.577 35.9757 295.891 39.0775 295.891C45.0254 295.891 49.5184 298.223 52.5567 302.886C52.7687 303.211 53.1811 303.343 53.5354 303.185L73.791 294.173C74.0925 294.039 74.2109 293.672 74.043 293.388C73.8198 293.009 73.5258 292.516 73.3305 292.207C69.8584 286.718 65.3674 282.63 59.7353 279.514C53.5318 276.083 46.6459 274.367 39.0775 274.367C29.0277 274.367 20.622 277.019 13.8601 282.322C7.09818 287.625 3.71728 294.893 3.71728 304.126C3.71728 310.24 5.3612 315.324 8.6491 319.379C11.937 323.435 15.9382 326.398 20.653 328.27C25.3677 330.141 30.0823 331.701 34.7971 332.949C39.5118 334.196 43.513 335.6 46.8009 337.16C50.0888 338.719 51.7328 340.747 51.7328 343.242C51.7328 348.608 47.4523 351.29 38.8914 351.29C30.7424 351.29 25.0953 348.262 21.9502 342.204C21.6801 341.684 21.0618 341.446 20.5271 341.684L0.328518 350.685C0.0438428 350.811 -0.0805599 351.149 0.0548193 351.43C0.136548 351.6 0.222685 351.777 0.285695 351.904C7.34445 366.093 20.2129 373.188 38.8914 373.188C49.5616 373.188 58.4636 370.599 65.5977 365.421C72.7318 360.243 76.2988 352.85 76.2988 343.242C76.2988 336.879 74.6549 331.576 71.367 327.334C68.0791 323.091 64.0778 320.066 59.3631 318.257C54.6484 316.447 49.9337 314.95 45.219 313.765C40.5043 312.579 36.5031 311.207 33.2152 309.647Z"
										fill="#212067"
									/>
								</svg>
							</div>
						</Link>
					</div>
				</div>
			)}
		</>
	);
};

export default Page;
